---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: "Test GitHub Action ðŸ§ª"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  ### Test String Validation (No Signature Check) ###
  test-string-validation:
    name: "Test String Validation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Test SemVer string - valid"
        uses: ./
        id: semver-valid
        with:
          tag_string: "1.2.3"
          require_type: semver

      - name: "Verify SemVer output"
        shell: bash
        run: |
          if [ "${{ steps.semver-valid.outputs.tag_type }}" != "semver" ]; then
            echo "Error: Expected tag_type=semver, got \
              ${{ steps.semver-valid.outputs.tag_type }}"
            exit 1
          fi
          if [ "${{ steps.semver-valid.outputs.version_prefix }}" \
            != "false" ]; then
            echo "Error: Expected version_prefix=false"
            exit 1
          fi
          echo "âœ“ SemVer string validation passed"

      - name: "Test SemVer string with v prefix"
        uses: ./
        id: semver-prefix
        with:
          tag_string: "v2.3.1-beta.1"
          require_type: semver

      - name: "Verify prefix detection"
        shell: bash
        run: |
          if [ "${{ steps.semver-prefix.outputs.version_prefix }}" \
            != "true" ]; then
            echo "Error: Expected version_prefix=true"
            exit 1
          fi
          if [ "${{ steps.semver-prefix.outputs.development_tag }}" \
            != "true" ]; then
            echo "Error: Expected development_tag=true (beta)"
            exit 1
          fi
          echo "âœ“ Prefix and development tag detected"

      - name: "Test CalVer string - valid"
        uses: ./
        id: calver-valid
        with:
          tag_string: "2025.01.15"
          require_type: calver

      - name: "Verify CalVer output"
        shell: bash
        run: |
          if [ "${{ steps.calver-valid.outputs.tag_type }}" != "calver" ]; then
            echo "Error: Expected tag_type=calver, got \
              ${{ steps.calver-valid.outputs.tag_type }}"
            exit 1
          fi
          echo "âœ“ CalVer string validation passed"

      - name: "Test CalVer with development identifier"
        uses: ./
        id: calver-dev
        with:
          tag_string: "v2025.1.0-alpha.1"

      - name: "Verify development tag detection"
        shell: bash
        run: |
          if [ "${{ steps.calver-dev.outputs.development_tag }}" \
            != "true" ]; then
            echo "Error: Expected development_tag=true"
            exit 1
          fi
          echo "âœ“ Development tag detected in CalVer"

      - name: "Test type mismatch - should fail"
        uses: ./
        id: type-mismatch
        continue-on-error: true
        with:
          tag_string: "1.2.3"
          require_type: calver

      - name: "Verify type mismatch failed"
        if: steps.type-mismatch.outcome == 'success'
        shell: bash
        run: |
          echo "Error: Type mismatch should have failed"
          exit 1

      - name: "Test unknown format with require_type=none"
        uses: ./
        id: unknown-format
        with:
          tag_string: "random-tag-name"
          require_type: none

      - name: "Verify unknown format accepted"
        shell: bash
        run: |
          if [ "${{ steps.unknown-format.outputs.tag_type }}" \
            != "unknown" ]; then
            echo "Error: Expected tag_type=unknown"
            exit 1
          fi
          echo "âœ“ Unknown format accepted with require_type=none"

  ### Test Local Tag Validation (Tag Push Event Simulation) ###
  test-local-tags:
    name: "Test Local Tag Validation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: "Create test tags locally"
        shell: bash
        run: |
          git config user.name "Test User"
          git config user.email "test@example.com"

          # Create unsigned tag
          git tag -a test-semver-1.0.0 -m "Test SemVer tag"
          git tag -a test-calver-2025.01.0 -m "Test CalVer tag"
          git tag -a test-dev-1.0.0-beta -m "Test dev tag"

          git tag -l

      - name: "Test validation with explicit tag_string"
        uses: ./
        id: explicit-tag
        with:
          tag_string: "test-semver-1.0.0"
          require_type: none

      - name: "Test missing tag with permit_missing=true"
        uses: ./
        id: missing-permitted
        with:
          permit_missing: true

      - name: "Verify permit_missing worked"
        shell: bash
        run: |
          if [ "${{ steps.missing-permitted.outputs.valid }}" != "true" ]; then
            echo "Error: Should succeed with permit_missing=true"
            exit 1
          fi
          echo "âœ“ permit_missing=true works correctly"

      - name: "Test missing tag with permit_missing=false - should fail"
        uses: ./
        id: missing-fail
        continue-on-error: true
        with:
          permit_missing: false

      - name: "Verify missing tag failed"
        if: steps.missing-fail.outcome == 'success'
        shell: bash
        run: |
          echo "Error: Should have failed without permit_missing"
          exit 1

  ### Test Remote Tag Validation ###
  test-remote-tags:
    name: "Test Remote Tag Validation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Test remote tag - semantic versioning"
        uses: ./
        id: remote-semver
        with:
          tag_location: >-
            lfreleng-actions/test-tags-semantic/v0.1.2-unsigned
          require_type: semver
          permit_missing: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Verify remote tag validation"
        shell: bash
        run: |
          echo "Tag Name: ${{ steps.remote-semver.outputs.tag_name }}"
          echo "Tag Type: ${{ steps.remote-semver.outputs.tag_type }}"
          echo "Signing Type: ${{ steps.remote-semver.outputs.signing_type }}"

      - name: "Test remote tag - calendar versioning"
        uses: ./
        id: remote-calver
        with:
          tag_location: >-
            lfreleng-actions/test-tags-calver/2025.1.2-unsigned
          require_type: calver
          permit_missing: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Test invalid tag_location format - should fail"
        uses: ./
        id: invalid-location
        continue-on-error: true
        with:
          tag_location: "invalid-format"
          permit_missing: false

      - name: "Verify invalid format failed"
        if: steps.invalid-location.outcome == 'success'
        shell: bash
        run: |
          echo "Error: Invalid tag_location should have failed"
          exit 1

      - name: "Test non-existent remote tag with permit_missing=true"
        uses: ./
        id: missing-remote
        with:
          tag_location: >-
            lfreleng-actions/test-tags-semantic/v999.999.999
          permit_missing: true

      - name: "Test tag with v prefix stripping"
        uses: ./
        id: prefix-strip
        with:
          tag_location: >-
            lfreleng-actions/test-tags-semantic/v0.1.0
          permit_missing: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Test with token for rate limit increase"
        uses: ./
        id: with-token
        with:
          tag_location: >-
            lfreleng-actions/test-tags-semantic/v0.1.0
          require_type: semver
          permit_missing: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Verify token usage succeeded"
        shell: bash
        run: |
          if [ "${{ steps.with-token.outputs.valid }}" != "true" ]; then
            echo "Error: Token-authenticated request should have succeeded"
            exit 1
          fi
          echo "âœ“ Token-authenticated request succeeded"

  ### Test Signature Validation ###
  test-signatures:
    name: "Test Signature Detection"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5

    steps:
      - name: "Checkout test-tags-semantic repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: lfreleng-actions/test-tags-semantic
          fetch-depth: 0
          path: test-repo-semver

      - name: "Checkout test-tags-calver repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: lfreleng-actions/test-tags-calver
          fetch-depth: 0
          path: test-repo-calver

      - name: "Checkout action repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: action-code

      - name: "Import GPG test key for signature verification"
        # yamllint disable-line rule:line-length
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4
        # Allow failure when GPG_PRIVATE_KEY secret is not set
        # (tests will then expect gpg-unverifiable instead of gpg)
        continue-on-error: true
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          trust_level: ultimate

      - name: "Set GPG key availability flag"
        shell: bash
        run: |
          if gpg --list-secret-keys "test@tag-validate-action.local" \
            &>/dev/null; then
            echo "GPG_KEY_AVAILABLE=true" >> "$GITHUB_ENV"
            echo "âœ“ GPG test key available"
          else
            echo "GPG_KEY_AVAILABLE=false" >> "$GITHUB_ENV"
            echo "No GPG key available - tests expect gpg-unverifiable"
          fi

      - name: "Test string mode (always unsigned)"
        uses: ./action-code
        id: string-mode
        with:
          tag_string: "v0.1.2-unsigned"

      - name: "Verify string mode reports unsigned"
        shell: bash
        run: |
          echo "Signing Type: ${{ steps.string-mode.outputs.signing_type }}"
          if [ "${{ steps.string-mode.outputs.signing_type }}" \
            != "unsigned" ]; then
            echo "Error: Expected signing_type=unsigned in string mode"
            exit 1
          fi
          echo "âœ“ String mode correctly reports unsigned"

      - name: "Test GPG-signed tag detection (semver)"
        uses: ./action-code
        id: gpg-semver
        with:
          tag_location: test-repo-semver/v0.1.4-gpg-test

      - name: "Verify GPG signature detection (semver)"
        shell: bash
        run: |
          echo "Signing Type: ${{ steps.gpg-semver.outputs.signing_type }}"
          echo "GPG Key Available: ${{ env.GPG_KEY_AVAILABLE }}"

          # Expected result depends on whether GPG key is available
          if [ "${{ env.GPG_KEY_AVAILABLE }}" = "true" ]; then
            # With key: should verify as 'gpg'
            if [ "${{ steps.gpg-semver.outputs.signing_type }}" != "gpg" ]; then
              echo "Error: Expected signing_type=gpg (key available)"
              exit 1
            fi
            echo "âœ“ GPG signature verified correctly"
          else
            # Without key: should be 'gpg-unverifiable'
            if [ "${{ steps.gpg-semver.outputs.signing_type }}" \
              != "gpg-unverifiable" ]; then
              echo "Error: Expected signing_type=gpg-unverifiable"
              exit 1
            fi
            echo "âœ“ GPG signature detected but unverifiable"
          fi

      - name: "Test SSH-signed tag detection (semver)"
        uses: ./action-code
        id: ssh-semver
        with:
          tag_location: test-repo-semver/v0.1.3-ssh-signed

      - name: "Verify SSH signature detection (semver)"
        shell: bash
        run: |
          echo "Signing Type: ${{ steps.ssh-semver.outputs.signing_type }}"
          if [ "${{ steps.ssh-semver.outputs.signing_type }}" \
            != "ssh" ]; then
            echo "Error: Expected signing_type=ssh for v0.1.3-ssh-signed"
            exit 1
          fi
          echo "âœ“ SSH signature detected correctly"

      - name: "Test unsigned tag detection (semver)"
        uses: ./action-code
        id: unsigned-semver
        with:
          tag_location: test-repo-semver/v0.1.2-unsigned

      - name: "Verify unsigned tag detection (semver)"
        shell: bash
        run: |
          echo \
            "Signing Type: ${{ steps.unsigned-semver.outputs.signing_type }}"
          if [ "${{ steps.unsigned-semver.outputs.signing_type }}" \
            != "unsigned" ]; then
            echo "Error: Expected signing_type=unsigned for v0.1.2-unsigned"
            exit 1
          fi
          echo "âœ“ Unsigned tag detected correctly"

      - name: "Test GPG-signed tag detection (calver)"
        uses: ./action-code
        id: gpg-calver
        with:
          tag_location: test-repo-calver/2025.1.4-gpg-test

      - name: "Verify GPG signature detection (calver)"
        shell: bash
        run: |
          echo "Signing Type: ${{ steps.gpg-calver.outputs.signing_type }}"
          echo "GPG Key Available: ${{ env.GPG_KEY_AVAILABLE }}"

          # Expected result depends on whether GPG key is available
          if [ "${{ env.GPG_KEY_AVAILABLE }}" = "true" ]; then
            # With key: should verify as 'gpg'
            if [ "${{ steps.gpg-calver.outputs.signing_type }}" != "gpg" ]; then
              echo "Error: Expected signing_type=gpg (key available)"
              exit 1
            fi
            echo "âœ“ GPG signature verified correctly"
          else
            # Without key: should be 'gpg-unverifiable'
            if [ "${{ steps.gpg-calver.outputs.signing_type }}" \
              != "gpg-unverifiable" ]; then
              echo "Error: Expected signing_type=gpg-unverifiable"
              exit 1
            fi
            echo "âœ“ GPG signature detected but unverifiable"
          fi

      - name: "Test SSH-signed tag detection (calver)"
        uses: ./action-code
        id: ssh-calver
        with:
          tag_location: test-repo-calver/2025.1.3-ssh-signed

      - name: "Verify SSH signature detection (calver)"
        shell: bash
        run: |
          echo "Signing Type: ${{ steps.ssh-calver.outputs.signing_type }}"
          if [ "${{ steps.ssh-calver.outputs.signing_type }}" \
            != "ssh" ]; then
            echo "Error: Expected signing_type=ssh for 2025.1.3-ssh-signed"
            exit 1
          fi
          echo "âœ“ SSH signature detected correctly (calver)"

      - name: "Test unsigned tag detection (calver)"
        uses: ./action-code
        id: unsigned-calver
        with:
          tag_location: test-repo-calver/2025.1.2-unsigned

      - name: "Verify unsigned tag detection (calver)"
        shell: bash
        run: |
          echo \
            "Signing Type: ${{ steps.unsigned-calver.outputs.signing_type }}"
          if [ "${{ steps.unsigned-calver.outputs.signing_type }}" \
            != "unsigned" ]; then
            echo "Error: Expected signing_type=unsigned for 2025.1.2-unsigned"
            exit 1
          fi
          echo "âœ“ Unsigned tag detected correctly (calver)"

      - name: "Test GPG-unverifiable tag detection (semver)"
        uses: ./action-code
        id: gpg-unverifiable-semver
        with:
          tag_location: test-repo-semver/v0.1.5-gpg-mwatkins

      - name: "Verify GPG-unverifiable signature detection (semver)"
        shell: bash
        # yamllint disable rule:line-length
        run: |
          echo "Signing Type: ${{ steps.gpg-unverifiable-semver.outputs.signing_type }}"
          if [ "${{ steps.gpg-unverifiable-semver.outputs.signing_type }}" \
            != "gpg-unverifiable" ]; then
            echo "Error: Expected signing_type=gpg-unverifiable for" \
                 "v0.1.5-gpg-mwatkins (signed with unknown key)"
            exit 1
          fi
          echo "âœ“ GPG-unverifiable signature detected correctly (semver)"
        # yamllint enable rule:line-length

      - name: "Test GPG-unverifiable tag detection (calver)"
        uses: ./action-code
        id: gpg-unverifiable-calver
        with:
          tag_location: test-repo-calver/2025.1.5-gpg-mwatkins

      - name: "Verify GPG-unverifiable signature detection (calver)"
        shell: bash
        # yamllint disable rule:line-length
        run: |
          echo "Signing Type: ${{ steps.gpg-unverifiable-calver.outputs.signing_type }}"
          if [ "${{ steps.gpg-unverifiable-calver.outputs.signing_type }}" \
            != "gpg-unverifiable" ]; then
            echo "Error: Expected signing_type=gpg-unverifiable for" \
                 "2025.1.5-gpg-mwatkins (signed with unknown key)"
            exit 1
          fi
          echo "âœ“ GPG-unverifiable signature detected correctly (calver)"
        # yamllint enable rule:line-length

      - name: "Test require_signed=true with GPG-unverifiable tag (should fail)"
        uses: ./action-code
        id: require-signed-unverifiable
        continue-on-error: true
        with:
          tag_location: test-repo-semver/v0.1.5-gpg-mwatkins
          require_signed: true

      - name: "Verify require_signed=true rejects GPG-unverifiable tag"
        shell: bash
        run: |
          if [ "${{ steps.require-signed-unverifiable.outcome }}" \
            == "success" ]; then
            echo "Error: require_signed=true should reject" \
                 "gpg-unverifiable signatures"
            exit 1
          fi
          echo "âœ“ require_signed=true correctly rejected gpg-unverifiable tag"

      - name: "Test require_signed=true with GPG tag"
        uses: ./action-code
        id: require-signed-gpg
        continue-on-error: true
        with:
          tag_location: test-repo-semver/v0.1.4-gpg-test
          require_signed: true

      - name: "Verify require_signed=true with GPG tag"
        shell: bash
        run: |
          # SECURITY: require_signed=true now rejects gpg-unverifiable
          # This test passes only if GPG key is available (signature verifiable)
          if [ "${{ env.GPG_KEY_AVAILABLE }}" = "true" ]; then
            # With key: signature is verifiable, should pass
            if [ "${{ steps.require-signed-gpg.outcome }}" \
              != "success" ]; then
              echo "Error: require_signed=true should pass with" \
                   "verifiable GPG signature"
              exit 1
            fi
            echo "âœ“ require_signed=true accepted verifiable signature"
          else
            # Without key: signature is unverifiable, should fail
            if [ "${{ steps.require-signed-gpg.outcome }}" \
              != "failure" ]; then
              echo "Error: require_signed=true should reject" \
                   "unverifiable GPG signature"
              exit 1
            fi
            echo "âœ“ require_signed=true rejected unverifiable signature"
          fi

      - name: "Test require_signed=true with SSH tag (should pass)"
        uses: ./action-code
        id: require-signed-ssh
        with:
          tag_location: test-repo-semver/v0.1.3-ssh-signed
          require_signed: true

      - name: "Test require_signed=true with unsigned tag (should fail)"
        uses: ./action-code
        id: require-signed-fail
        continue-on-error: true
        with:
          tag_location: test-repo-semver/v0.1.2-unsigned
          require_signed: true

      - name: "Verify require_signed=true rejected unsigned tag"
        shell: bash
        run: |
          if [ "${{ steps.require-signed-fail.outcome }}" == "success" ]; then
            echo "Error: require_signed=true should reject unsigned tags"
            exit 1
          fi
          echo "âœ“ require_signed=true correctly rejected unsigned tag"

      - name: "Test require_signed=false with unsigned tag (should pass)"
        uses: ./action-code
        id: require-unsigned
        with:
          tag_location: test-repo-semver/v0.1.2-unsigned
          require_signed: false

      - name: "Test require_signed=ambivalent with any tag (should pass)"
        uses: ./action-code
        id: ambivalent-any
        with:
          tag_location: test-repo-semver/v0.1.2-unsigned
          require_signed: ambivalent

  ### Test Signature Requirements ###
  test-signature-requirements:
    name: "Test Signature Requirements"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: "Create unsigned tag"
        shell: bash
        run: |
          git config user.name "Test User"
          git config user.email "test@example.com"
          git tag -a unsigned-test-1.0.0 -m "Unsigned test tag"

      - name: "Test require_signed=ambivalent (default)"
        uses: ./
        id: ambivalent
        with:
          tag_string: "unsigned-test-1.0.0"
          require_signed: ambivalent

      - name: "Test require_signed=false with unsigned (should pass)"
        uses: ./
        id: unsigned-ok
        with:
          tag_string: "unsigned-test-1.0.0"
          require_signed: false

      - name: "Test case insensitivity"
        uses: ./
        id: case-test
        with:
          tag_string: "1.0.0"
          require_type: SEMVER
          require_signed: AMBIVALENT

      - name: "Verify case insensitivity"
        shell: bash
        run: |
          if [ "${{ steps.case-test.outputs.tag_type }}" != "semver" ]; then
            echo "Error: Case insensitive require_type failed"
            exit 1
          fi
          echo "âœ“ Case insensitive inputs work correctly"

  ### Test Development Tag Detection ###
  test-development-tags:
    name: "Test Development Tag Detection"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Test alpha tag"
        uses: ./
        id: alpha
        with:
          tag_string: "1.0.0-alpha.1"

      - name: "Verify alpha detected"
        shell: bash
        run: |
          if [ "${{ steps.alpha.outputs.development_tag }}" != "true" ]; then
            echo "Error: alpha not detected as development"
            exit 1
          fi

      - name: "Test beta tag"
        uses: ./
        id: beta
        with:
          tag_string: "v2.0.0-beta"

      - name: "Test rc tag"
        uses: ./
        id: rc
        with:
          tag_string: "1.0.0-rc.1"

      - name: "Test dev tag"
        uses: ./
        id: dev
        with:
          tag_string: "2025.01-dev"

      - name: "Test snapshot tag"
        uses: ./
        id: snapshot
        with:
          tag_string: "1.0.0-SNAPSHOT"

      - name: "Test stable tag (not development)"
        uses: ./
        id: stable
        with:
          tag_string: "1.0.0"

      - name: "Verify stable not flagged as dev"
        shell: bash
        run: |
          if [ "${{ steps.stable.outputs.development_tag }}" \
            != "false" ]; then
            echo "Error: Stable tag incorrectly flagged as development"
            exit 1
          fi
          echo "âœ“ Development tag detection works correctly"

  ### Test All Input Combinations ###
  test-input-priority:
    name: "Test Input Priority"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Test tag_location takes priority over tag_string"
        uses: ./
        id: priority-test
        with:
          tag_location: >-
            lfreleng-actions/test-tags-semantic/v0.1.2-unsigned
          tag_string: "this-should-be-ignored"
          permit_missing: true

      - name: "Verify tag_location was used"
        shell: bash
        run: |
          tag_name="${{ steps.priority-test.outputs.tag_name }}"
          if [[ "$tag_name" == *"ignored"* ]]; then
            echo "Error: tag_string was used instead of tag_location"
            exit 1
          fi
          echo "âœ“ Input priority works correctly"

  ### Test Edge Cases ###
  test-edge-cases:
    name: "Test Edge Cases"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Test empty tag_string with permit_missing=true"
        uses: ./
        id: empty-string
        with:
          tag_string: ""
          permit_missing: true

      - name: "Test very long version string"
        uses: ./
        id: long-version
        with:
          tag_string: "1.0.0-beta.1+build.12345.abcdef1234567890"
          require_type: semver

      - name: "Test version with all dev keywords"
        uses: ./
        id: multi-dev
        with:
          tag_string: "1.0.0-alpha-pre-dev"

      - name: "Verify multiple dev keywords detected"
        shell: bash
        run: |
          if [ "${{ steps.multi-dev.outputs.development_tag }}" \
            != "true" ]; then
            echo "Error: Multiple dev keywords not detected"
            exit 1
          fi

      - name: "Test uppercase V prefix"
        uses: ./
        id: uppercase-v
        with:
          tag_string: "V1.0.0"

      - name: "Verify uppercase V detected"
        shell: bash
        run: |
          if [ "${{ steps.uppercase-v.outputs.version_prefix }}" \
            != "true" ]; then
            echo "Error: Uppercase V prefix not detected"
            exit 1
          fi
          echo "âœ“ Edge cases handled correctly"

  ### Summary ###
  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - test-string-validation
      - test-local-tags
      - test-remote-tags
      - test-signatures
      - test-signature-requirements
      - test-development-tags
      - test-input-priority
      - test-edge-cases
    if: always()
    steps:
      - name: "Display test results"
        shell: bash
        run: |
          {
            echo "## Test Results Summary"
            echo ""
            echo "All test jobs completed!"
            echo ""
            echo "âœ… String validation tests"
            echo "âœ… Local tag tests"
            echo "âœ… Remote tag tests"
            echo "âœ… Signature tests"
            echo "âœ… Development tag tests"
            echo "âœ… Input priority tests"
            echo "âœ… Edge case tests"
          } >> "$GITHUB_STEP_SUMMARY"
